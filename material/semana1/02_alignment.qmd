---
title: "02 - Alinhamento com Cell Ranger"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-tools: true
---

## Motiva√ß√£o

Ao realizar um experimento de transcript√¥mica de c√©lula √∫nica com a tecnologia 10x Genomics, o sequenciador fornece arquivos no formato BCL. No entanto, o pesquisador precisa de uma matriz de contagem por c√©lula para realizar an√°lises downstream como clustering, anota√ß√£o e detec√ß√£o de tipos celulares.

Este tutorial resolve um problema comum: como transformar dados brutos do sequenciador em uma matriz de express√£o confi√°vel, e como interpretar o relat√≥rio de qualidade do pipeline.

## Contextualiza√ß√£o

O **Cell Ranger** √© o pipeline oficial da 10x Genomics para processar dados de scRNA-seq. Ele √© composto por uma s√©rie de ferramentas coordenadas por um framework interno chamado **Martian**, que gerencia etapas paralelas e arquivos intermedi√°rios. O Cell Ranger executa diversas etapas, incluindo demultiplexa√ß√£o, alinhamento, deduplica√ß√£o de UMIs, quantifica√ß√£o g√™nica e gera√ß√£o de relat√≥rios de qualidade. Para instalar o Cell Ranger, por favor, acesso esse [link](https://www.10xgenomics.com/support/software/cell-ranger/7.2/tutorials/cr-tutorial-in). 

> üìå Nota: Durante a etapa de alinhamento, o Cell Ranger utiliza o **STAR (Spliced Transcripts Alignment to a Reference)** como seu motor principal para mapear os reads de RNA ao genoma de refer√™ncia. O STAR √© um dos alinhadores mais r√°pidos e sens√≠veis para dados de RNA-seq, sendo particularmente adequado para capturar splicing e isoformas em organismos eucariotos. Caso tenha interesse em entender mais sobre o algoritmo, veja o [link](https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/1.0/map/cr-counter)

## Ferramentas utilizadas

As etapas do pipeline e suas respectivas fun√ß√µes s√£o:

- **`cellranger mkfastq`**: converte arquivos BCL em arquivos FASTQ por amostra.
- **`cellranger mkref`**: constr√≥i um genoma de refer√™ncia com anota√ß√µes para alinhamento.
- **`cellranger count`**: alinha os reads (com STAR), deduplica UMIs, gera matrizes de express√£o e relat√≥rio final de qualidade.

## 1. Convers√£o de BCL para FASTQ

```bash
cellranger mkfastq \
  --id=Sample001 \
  --run=/mnt/bcl_run_folder \
  --csv=sample_sheet.csv
```

- O arquivo `sample_sheet.csv` deve seguir o padr√£o Illumina, especificando amostras, lanes e barcodes.

### 1.1. Sobre o padr√£o Illumina
O arquivo CSV segue uma estrutura com cabe√ßalho padronizado e colunas obrigat√≥rias como `Sample_ID`, `Sample_Name`, `Index`, `Lane`, entre outras. Um exemplo simplificado:

```txt
[Data]
Lane,Sample_ID,Sample_Name,Index
1,Sample001,Sample001,SI-GA-A1
```

- A se√ß√£o `[Data]` delimita o in√≠cio da tabela.
- `Lane` N√∫mero da lane do flowcell (geralmente 1, mas pode ser m√∫ltiplas).
- `Sample_ID` Identificador interno para a amostra (aparece nos diret√≥rios).
- `Sample_Name`Nome descritivo da amostra, que aparece no nome dos arquivos FASTQ.
- `Index` Sequ√™ncia ou nome do √≠ndice (barcode) usado para essa amostra.

Para mais detalhes, consulte a [documenta√ß√£o da Illumina](https://support.illumina.com/). 

### 1.2. Sobre o padr√£o 10x Genomics
Ap√≥s a execu√ß√£o do `cellranger mkfastq`, os arquivos FASTQ seguem uma conven√ß√£o espec√≠fica da 10x Genomics. Para cada amostra, s√£o gerados arquivos separados por tipo de leitura:

```txt
bcl2fastq_output
|-- HFLC5BBXX
    |-- Sample001
    |   |-- Sample001_S1_L001_I1_001.fastq.gz
    |   |-- Sample001_S1_L001_R1_001.fastq.gz
    |   |-- Sample001_S1_L001_R2_001.fastq.gz
|-- Reports
|-- Stats
|-- Undetermined_S0_L001_I1_001.fastq.gz
|-- Undetermined_S0_L001_R1_001.fastq.gz
|-- Undetermined_S0_L001_R2_001.fastq.gz
```

Al√©m disso, a nomenclatura do arquivo √© composta por diferentes campos. Veja abaixo:

```txt
[Sample Name]_S1_L00[Lane Number]_[Read Type]_001.fastq.gz
```

Esse nome √© composto por blocos separados por sublinhados (`_`), com os seguintes significados:

- **Sample001**: nome da amostra, herdado do campo `Sample_Name` do Sample Sheet.
- **S1**: identificador da amostra atribu√≠do automaticamente pelo `bcl2fastq`.
- **L001**: n√∫mero da lane (neste caso, lane 1).
- **R1**: tipo da leitura:
  - `R1` = Read 1 (Cell barcode + UMI)
  - `R2` = Read 2 (cDNA)
  - `I1` = Index Read 1 (Sample index)
- **001**: n√∫mero do set de leitura (geralmente fixo como 001).

## 2. Constru√ß√£o do Genoma de Refer√™ncia

```bash
cellranger mkref \
  --genome=GRCh38_custom \
  --fasta=genome.fa \
  --genes=genes.gtf
```

- Entrada: arquivos `FASTA` com a sequ√™ncia do genoma e `GTF` com as anota√ß√µes de genes.
- Sa√≠da: diret√≥rio contendo a refer√™ncia indexada para uso posterior.

## 3. Processamento com `cellranger count`

```bash
cellranger count \
  --id=Sample001 \
  --transcriptome=/refs/GRCh38_custom \
  --fastqs=/mnt/fastqs \
  --sample=Sample001
```

Esta etapa realiza:

- Alinhamento com STAR.
- Identifica√ß√£o de c√©lulas por barcodes √∫nicos.
- Quantifica√ß√£o g√™nica por UMI.
- Gera√ß√£o das matrizes de contagem e do relat√≥rio de qualidade (`web_summary.html`).

## 4. Interpreta√ß√£o do Relat√≥rio

O Cell Ranger gera um relat√≥rio interativo (`web_summary.html`) com gr√°ficos e tabelas que ajudam a avaliar a qualidade do sequenciamento e da captura celular.

Principais m√©tricas e suas interpreta√ß√µes:

- **Estimated Number of Cells**: n√∫mero estimado de c√©lulas √∫nicas com base na distribui√ß√£o de UMIs.
- **Reads Mapped to Genome**: porcentagem de reads que alinharam ao genoma de refer√™ncia (ideal > 80%).
- **Sequencing Saturation**: medida de redund√¢ncia dos reads (ideal > 40%); valores baixos sugerem que mais sequenciamento pode ser necess√°rio.
- **Fraction Reads in Cells**: fra√ß√£o de reads atribu√≠das a barcodes v√°lidos (ideal > 70%).
- **Valid Barcodes**: porcentagem de barcodes reconhecidos como v√°lidos (ideal > 90%).
- **Median Genes per Cell**: n√∫mero mediano de genes detectados por c√©lula; depende do tipo celular e qualidade da amostra.

## Questionamentos

- O n√∫mero de c√©lulas detectadas est√° de acordo com a expectativa para o protocolo de captura utilizado?
- H√° evid√™ncia de RNA ambiente ou c√©lulas estressadas (baixa fra√ß√£o de reads em c√©lulas)?
- A satura√ß√£o sugere que o sequenciamento foi suficiente ou deveria ser mais profundo?
- A distribui√ß√£o dos genes por c√©lula est√° coerente com o tipo de tecido ou condi√ß√£o estudada?
- Os barcodes inv√°lidos est√£o ocorrendo em excesso, indicando problemas na biblioteca?

## Coment√°rios Finais

Este tutorial demonstrou o uso do Cell Ranger para:

- Processar dados brutos (BCL) at√© a gera√ß√£o das matrizes de contagem por c√©lula.
- Avaliar a qualidade dos dados utilizando o relat√≥rio interativo fornecido pelo pr√≥prio pipeline.
- Refletir criticamente sobre os resultados, visando decis√µes informadas para an√°lises downstream.

A compreens√£o dessa etapa √© essencial para garantir que an√°lises como clustering, infer√™ncia de trajet√≥rias e anota√ß√£o celular sejam conduzidas com dados confi√°veis e bem interpretados.

## Recursos adicionais

- [Documenta√ß√£o oficial](https://support.10xgenomics.com/single-cell-gene-expression)
- [Tutorial de QC no Seurat](https://satijalab.org/seurat/articles/pbmc3k_tutorial.html)
- [STAR aligner](https://github.com/alexdobin/STAR) 
