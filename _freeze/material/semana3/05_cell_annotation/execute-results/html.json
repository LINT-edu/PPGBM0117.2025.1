{
  "hash": "281ceb549cdf24ec6e8662ba2ccb6bf9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"05 - Anotação de células\"\nformat:\n  html:\n    toc: true\n    toc-depth: 3\nexecute: \n  cache: false\n---\n\n\n\n\n## Motivação\n\nA anotação de células é uma etapa crítica na análise de dados de transcriptômica de célula única (scRNA-seq). Ela permite transformar clusters não rotulados em informações biológicas significativas, descrevendo tipos celulares e seus estados funcionais. A anotação adequada é essencial para interpretações corretas e para garantir reprodutibilidade e comparabilidade entre estudos.\n\n## Contextualização\n\nApós etapas de pré-processamento e clusterização, cada célula ou agrupamento (cluster) carece de uma identidade biológica. A anotação pode ser realizada de maneira:\n\n-   **Manual**: com base na expressão de genes marcadores conhecidos.\n-   **Automatizada**: utilizando ferramentas que comparam perfis de expressão com bancos de dados de referência.\n\nNeste tutorial, mostraremos ambas as abordagens usando o pacote `Seurat` e ferramentas como `SingleR` para anotação automática.\n\n## Ajustar ambientar e carregar pacotes\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Instalar pacotes necessários caso não estejam instalados\nif (!requireNamespace(\"SingleR\")) BiocManager::install(\"SingleR\")\nif (!requireNamespace(\"celldex\")) BiocManager::install(\"celldex\")\n\n# Carregar pacotes\nlibrary(Seurat)\nlibrary(presto)\nlibrary(SingleR)\nlibrary(celldex)\nlibrary(SingleCellExperiment)\nlibrary(dplyr)\n\n# Definindo diretorio padrao\nknitr::opts_knit$set(\n  root.dir = \"/home/oandrefonseca/Disciplinas/PPGBM0117.2025.1\",\n  verbose = FALSE\n)\n\n# Aumentar o limite de uso de memoria\noptions(future.globals.maxSize = 5 * 1024^3) # 5 GB, por exemplo\n```\n:::\n\n\n\n\n## Carregando dados do projeto\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Carregando um objeto Seurat já processado (pré-clusterizado)\nseurat_object <- readRDS(file = here::here(\"data/seurat_clustered.RDS\"))\n\n# Verificar os clusters\nDimPlot(seurat_object, group.by = \"seurat_clusters\")\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-umap-1.png){#fig-umap fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## Anotação Manual\n\nA anotação manual é uma abordagem fundamental, especialmente em experimentos onde o conhecimento biológico é indispensável para interpretar os dados.\n\n**O que é feito nesta etapa?**\n\nApós a clusterização, cada agrupamento de células é apenas um número (por exemplo, Cluster 0, Cluster 1, Cluster N...). O objetivo é atribuir esses agrupamentos identidade biológica (celular) com base na expressão de **genes marcadores bem conhecidos**.\n\n**Como fazemos isso?**\n\n-   Usamos funções como `FindAllMarkers` para identificar genes mais expressos em cada cluster.\n-   Verificamos a expressão desses genes em visualizações como `FeaturePlot` ou `VlnPlot`.\n-   Com base no padrão de expressão, atribuímos rótulos apropriados. Por exemplo:\n    -   **CD3D+** → Provavelmente células T\n    -   **MS4A1+** → Provavelmente células B\n    -   **LYZ+** → Provavelmente monócitos/macrófagos\n    -   **PPBP+** → Plaquetas\n\n::: {.callout-note collapse=\"false\"}\n**Importante**: A anotação manual exige conhecimento prévio da literatura para garantir a precisão das atribuições. É recomendável validar com bancos de dados públicos e reavaliar periodicamente.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Vamos fazer uma anotacao mais generica usando a resolucao de 0.25\nIdents(seurat_object) <- \"RNA_snn_res.0.25\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!file.exists(here::here(\"data/cluster_markers.RDS\"))) {\n  \n  # Identificar genes marcadores para clusters\n  cluster_markers <- FindAllMarkers(seurat_object, only.pos = TRUE)\n  saveRDS(file = here::here(\"data/cluster_markers.RDS\"), object = cluster_markers)\n  \n} \n\ncluster_markers <- readRDS(file = here::here(\"data/cluster_markers.RDS\"))\n```\n:::\n\n\n\n\n### Inspecionando DEGs\n\n\n\n\n::: {.cell .column-screen-inset-shaded}\n\n```{.r .cell-code}\n# Removendo resultados nao significativos\ncluster_markers_top <- cluster_markers %>%\n    filter(\n      p_val_adj <= 0.05,\n      avg_log2FC >= 0.25,\n      pct.1 >= 0.20,\n      pct.1 > pct.2\n    )\n\ncluster_markers_top <- cluster_markers_top %>%\n  group_by(cluster) %>%\n  top_n(20, avg_log2FC)\n\nDT::datatable(cluster_markers_top)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-74c8d631bb26376e3667\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-74c8d631bb26376e3667\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\",\"70\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"78\",\"79\",\"80\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"89\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"96\",\"97\",\"98\",\"99\",\"100\",\"101\",\"102\",\"103\",\"104\",\"105\",\"106\",\"107\",\"108\",\"109\",\"110\",\"111\",\"112\",\"113\",\"114\",\"115\",\"116\",\"117\",\"118\",\"119\",\"120\",\"121\",\"122\",\"123\",\"124\",\"125\",\"126\",\"127\",\"128\",\"129\",\"130\",\"131\",\"132\",\"133\",\"134\",\"135\",\"136\",\"137\",\"138\",\"139\",\"140\",\"141\",\"142\",\"143\",\"144\",\"145\",\"146\",\"147\",\"148\",\"149\",\"150\",\"151\",\"152\",\"153\",\"154\",\"155\",\"156\",\"157\",\"158\",\"159\",\"160\",\"161\",\"162\",\"163\",\"164\",\"165\",\"166\",\"167\",\"168\",\"169\",\"170\",\"171\",\"172\",\"173\",\"174\",\"175\",\"176\",\"177\",\"178\",\"179\",\"180\",\"181\",\"182\",\"183\",\"184\",\"185\",\"186\",\"187\",\"188\",\"189\",\"190\",\"191\",\"192\",\"193\",\"194\",\"195\",\"196\",\"197\",\"198\",\"199\",\"200\",\"201\",\"202\",\"203\",\"204\",\"205\",\"206\",\"207\",\"208\",\"209\",\"210\",\"211\",\"212\",\"213\",\"214\",\"215\",\"216\",\"217\",\"218\",\"219\",\"220\",\"221\",\"222\",\"223\",\"224\",\"225\",\"226\",\"227\",\"228\",\"229\",\"230\",\"231\",\"232\",\"233\",\"234\",\"235\",\"236\",\"237\",\"238\",\"239\",\"240\",\"241\",\"242\",\"243\",\"244\",\"245\",\"246\",\"247\",\"248\",\"249\",\"250\",\"251\",\"252\",\"253\",\"254\",\"255\",\"256\",\"257\",\"258\",\"259\",\"260\",\"261\",\"262\",\"263\",\"264\",\"265\",\"266\",\"267\",\"268\",\"269\",\"270\",\"271\",\"272\",\"273\",\"274\",\"275\",\"276\",\"277\",\"278\",\"279\",\"280\"],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4.090024579220807e-305,3.31286807027121e-254,5.237535032943135e-254,7.234214906096885e-248,1.909867733824729e-233,2.344663546982791e-214,2.499626281491231e-196,1.306309551306797e-176,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[4.19430160835666,4.462422105077413,3.866158516429722,3.975343373441819,3.198009613950024,3.8753392641405,3.443063129092986,3.688302255177548,3.774836137983459,5.295017437672462,3.280228355190501,3.449859128100867,3.27588707187869,6.501225136877947,4.671640687887166,5.710666275206384,3.657594062236802,4.295472328610779,4.684803939750214,3.085945119008653,2.070590824561996,1.882776954628902,1.936068403214024,1.877179921155223,2.12057900102707,2.030167649582727,2.758408345804698,1.981802567615238,1.874584087352549,1.976178035135634,1.888023662799131,1.98973432517217,1.965731730007881,2.090565814259219,1.941617747259998,2.479893854914993,2.029261862493956,1.903565505222307,1.951916344417413,1.97025569137194,3.523005009349556,2.773345610553043,2.895182116408602,2.750118480277489,2.52972724538604,5.313270268018277,2.651380522190211,3.062056740635256,3.00108487255069,2.93016673816032,3.535911015473296,4.047431334041834,2.983473487383582,3.50648185036387,3.001077895744444,3.212769100059687,3.810007771591895,2.768071399858978,2.53516817405242,2.895748373805191,8.370410651925948,8.07081459273115,5.543451377007351,7.468005240879989,6.270878383665468,7.170761496873302,7.314552430393741,6.511128548317856,7.598905105583732,6.10646464650889,5.400072636998436,6.03142282828444,7.750680769212346,6.350028425638407,6.882495141929769,6.619523906856993,6.850638705637815,6.604934309150052,7.146170773279236,7.341451178018962,10.540966464545,7.681920416318844,9.274605031758119,9.097795708033862,8.219020771912467,9.036787983775396,11.57162728399114,9.149040433823739,8.504694962228257,9.24319545992001,7.890501216369041,9.458270446621652,9.357731475402471,7.872677753729192,8.763582574824532,8.154579346493517,10.5684869326371,9.052430900429069,7.726095354714033,9.225788434894218,10.55635136222778,11.99393100612827,9.204324994836911,9.564064255788333,10.78795845405593,10.70529419514264,9.927130213537639,9.756670098110591,12.12880091905982,9.642395369513846,9.682403679035332,10.44440252411186,11.36571316025565,9.693673379901902,10.14645933378317,10.99061774912917,9.195322507163343,10.01431179689617,9.622270125764526,9.905674994292177,10.76054106294819,10.75892635314084,11.41528511388144,9.748402158807313,9.054602565893354,9.295102998372403,9.215197093749556,9.70615017094879,9.017315508339221,9.238148800621344,10.35753278528324,9.047380293533902,9.985889561442884,8.836638266610331,9.31336170155596,8.999971039312276,8.974612198989123,10.01695019837515,9.820826107326859,10.59849593945392,9.262213142410094,9.409286254443208,8.450828874242202,12.91589171535058,9.399796780656395,8.424581160975301,11.04326427072217,8.562542297626852,10.77164742118916,8.377878521613257,8.814182049853637,8.987037868142179,10.80467773461648,8.288607359164306,10.99319354809268,10.17012270835294,8.499906593927461,9.707923429986742,8.644333493705016,9.153891113538977,12.11068977455152,12.2628507546737,9.903310541226979,10.67885479780746,9.369151624428236,9.546452755586106,9.82288879427581,11.99018267353539,11.58871483210776,9.115435933816624,11.03793288959465,9.579527905276846,11.87569539903904,12.35642648676135,9.220391135571139,9.320852757738404,10.42825724274218,10.47994181057333,11.83648137410042,10.96850486779114,6.349134786832533,7.110390977062262,6.452538832590485,7.046742249124295,6.472511560309667,6.663169301454152,6.539177007778549,6.794022534251599,6.97730921587118,6.193921828065514,6.436732809724072,6.828972731584527,6.354341189696382,6.569658810014557,6.444711957089772,6.343404492961001,5.884824425104533,6.375340503588588,6.125471547596975,6.040646474406699,8.370895882462893,6.918539492237883,7.56446062432206,8.084146308807258,6.770321373959668,6.972082292264256,6.77162965132675,7.100975235633192,7.169956002061071,9.183645038411139,7.393168336786048,7.979281362104881,9.147821278725017,7.744864286047603,9.53723678448322,7.051060147490427,7.977406665368996,7.438022159996965,6.730265574504608,8.634201877799834,9.732103052736186,10.66045717396101,10.27675253036594,9.83107647714519,9.664397264110583,11.40886654185482,13.37186622977214,11.15536069175963,10.69333245876331,13.35232249717125,13.11063229596678,11.79639691693159,13.44514603695099,10.51625803634515,11.1055743257584,10.27586125427886,10.75910168756389,10.27719105042374,13.40225683222152,10.62476687504784,14.23773204105007,13.58729736512305,13.46869995481144,11.26855187063902,11.34626765355197,8.163259953942788,14.00177446190107,10.17871712803814,9.671817507664544,14.04698323454424,7.246127319705764,11.09879190774749,13.11355394773706,10.16358848157182,12.43704571493656,14.05094956577355,8.843598685775513,8.535946845040398,9.973987210228914,9.352947480873439,10.96816300856975,14.44226727564818,11.76162092684579,12.26636675109051,11.99638270378427,10.96982643392245,10.39397158702727,12.63467248209801,12.64029766603403,12.93367132639433,11.3680587352496,10.83190895445154,10.65134893954552,9.988068676912185,10.03486664743141,10.00089088504847,11.56432555697427,9.942488951846329,10.50103425935255,10.05160647893046],[0.902,0.788,0.659,0.626,0.598,0.574,0.59,0.492,0.498,0.436,0.406,0.348,0.327,0.273,0.26,0.244,0.253,0.24,0.227,0.236,0.736,0.742,0.6909999999999999,0.521,0.582,0.437,0.321,0.498,0.476,0.328,0.28,0.247,0.381,0.226,0.212,0.201,0.294,0.247,0.313,0.228,0.749,0.819,0.773,0.666,0.495,0.399,0.631,0.412,0.342,0.317,0.308,0.317,0.329,0.27,0.238,0.277,0.21,0.268,0.235,0.204,0.983,0.841,0.653,0.577,0.556,0.511,0.464,0.449,0.433,0.387,0.34,0.317,0.297,0.291,0.27,0.245,0.238,0.219,0.205,0.2,0.901,0.702,0.618,0.539,0.458,0.429,0.381,0.376,0.364,0.349,0.34,0.325,0.309,0.287,0.27,0.247,0.22,0.218,0.211,0.207,0.778,0.635,0.503,0.499,0.443,0.436,0.423,0.389,0.378,0.304,0.294,0.28,0.266,0.255,0.253,0.25,0.237,0.234,0.221,0.209,0.869,0.8070000000000001,0.772,0.763,0.67,0.666,0.64,0.624,0.578,0.452,0.456,0.374,0.334,0.326,0.281,0.271,0.235,0.235,0.235,0.201,0.9370000000000001,0.898,0.881,0.8070000000000001,0.8129999999999999,0.76,0.739,0.554,0.544,0.496,0.472,0.454,0.378,0.345,0.287,0.286,0.263,0.248,0.227,0.217,0.95,0.922,0.925,0.84,0.824,0.773,0.741,0.74,0.631,0.624,0.5659999999999999,0.545,0.431,0.409,0.375,0.322,0.279,0.269,0.261,0.22,0.861,0.8,0.802,0.695,0.664,0.65,0.636,0.617,0.585,0.524,0.457,0.442,0.441,0.431,0.428,0.417,0.396,0.369,0.291,0.281,0.874,0.65,0.601,0.57,0.538,0.518,0.503,0.49,0.462,0.442,0.429,0.384,0.355,0.322,0.314,0.308,0.277,0.272,0.254,0.212,0.773,0.726,0.727,0.6830000000000001,0.57,0.533,0.476,0.462,0.454,0.446,0.419,0.39,0.388,0.388,0.381,0.352,0.316,0.293,0.259,0.222,0.959,0.92,0.857,0.782,0.743,0.765,0.715,0.648,0.585,0.551,0.516,0.469,0.423,0.346,0.317,0.3,0.283,0.281,0.259,0.207,0.986,0.951,0.951,0.889,0.875,0.757,0.757,0.75,0.583,0.583,0.576,0.569,0.556,0.5,0.389,0.354,0.25,0.229,0.229,0.215],[0.126,0.089,0.07099999999999999,0.06900000000000001,0.059,0.055,0.081,0.042,0.061,0.018,0.093,0.051,0.038,0.008,0.027,0.013,0.026,0.019,0.012,0.025,0.361,0.383,0.394,0.3,0.381,0.246,0.139,0.317,0.317,0.172,0.126,0.105,0.255,0.122,0.11,0.103,0.185,0.148,0.209,0.142,0.146,0.234,0.216,0.119,0.109,0.017,0.256,0.06900000000000001,0.052,0.042,0.038,0.052,0.068,0.04,0.028,0.075,0.022,0.09,0.064,0.039,0.018,0.011,0.037,0.008,0.012,0.007,0.008999999999999999,0.006,0.005,0.008999999999999999,0.012,0.011,0.003,0.003,0.005,0.004,0.003,0.002,0.002,0.002,0.005,0.011,0.003,0.008,0.004,0.004,0,0.001,0.002,0.001,0.002,0.001,0.001,0.003,0.002,0.001,0,0.001,0.004,0.001,0.002,0.001,0.002,0.002,0,0.001,0.001,0,0,0.001,0,0,0,0,0,0,0.001,0,0,0,0.018,0.031,0.003,0.003,0.018,0.035,0.018,0.007,0.021,0.007,0.012,0.023,0,0.004,0.011,0.003,0.004,0.008999999999999999,0.011,0.004,0.011,0.008,0.02,0.001,0.007,0.01,0.001,0.001,0.001,0.005,0.002,0.001,0.001,0.001,0,0.001,0,0,0.001,0,0.004,0.004,0.029,0.002,0.008,0.018,0.002,0.001,0.001,0.003,0.001,0.002,0.001,0,0.001,0.001,0.001,0.003,0,0,0.023,0.013,0.016,0.01,0.008,0.008,0.008,0.007,0.006,0.006,0.004,0.003,0.005,0.003,0.004,0.004,0.006,0.003,0.003,0.003,0.014,0.011,0.005,0.003,0.005,0.008,0.006,0.006,0.004,0.001,0.004,0.002,0.001,0.003,0.001,0.005,0.001,0.002,0.003,0.001,0.004,0.004,0.006,0.003,0.003,0.001,0,0.001,0.001,0,0,0,0,0.001,0.001,0.001,0,0.001,0,0,0.002,0.002,0.001,0.002,0.002,0.048,0,0.003,0.005,0,0.013,0.002,0.001,0.001,0,0,0.002,0.002,0.001,0.001,0.008999999999999999,0.001,0.002,0.001,0.001,0.001,0.001,0,0,0.001,0,0.002,0,0.001,0.001,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.578994889053985e-300,1.278965847208903e-249,2.022002774818027e-249,2.792841006647764e-243,7.37323537320375e-229,9.051808089481762e-210,9.650057222325047e-192,5.043138653775021e-172,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"1\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"2\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"3\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"4\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"5\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"6\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"7\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"8\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"9\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"10\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"11\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"12\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"13\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\",\"14\"],[\"CCL5\",\"NKG7\",\"CD8A\",\"CTSW\",\"KLRK1\",\"GZMK\",\"GZMA\",\"CD8B\",\"PRF1\",\"GZMH\",\"GNLY\",\"KLRD1\",\"FASLG\",\"XCL2\",\"IFNG\",\"XCL1\",\"MATK\",\"CRTAM\",\"LINC02446\",\"EOMES\",\"CAMK4\",\"IL7R\",\"PDE3B\",\"TNIK\",\"PITPNC1\",\"BICDL1\",\"ANK3\",\"PHACTR2\",\"ABLIM1\",\"NELL2\",\"TCF7\",\"TESPA1\",\"MLLT3\",\"PGAP1\",\"AP3M2\",\"ABTB3\",\"TSHZ2\",\"ITPKB\",\"AOAH\",\"PRKCA\",\"TNFRSF4\",\"TNFRSF18\",\"BATF\",\"CTLA4\",\"CD4\",\"FOXP3\",\"CARD16\",\"LINC01943\",\"LAYN\",\"ENSG00000227240\",\"MAL\",\"CXCL13\",\"IL2RA\",\"RTKN2\",\"F5\",\"MAGEH1\",\"SOCAR\",\"NMB\",\"ZC2HC1A\",\"ETV7\",\"MS4A1\",\"BANK1\",\"ADAM28\",\"LINC00926\",\"BLK\",\"TNFRSF13B\",\"CD19\",\"ENSG00000289963\",\"LINC02397\",\"TNFRSF13C\",\"ADAM7-AS1\",\"FCRLA\",\"LINC01857\",\"CD22\",\"SCIMP\",\"COL19A1\",\"PLEKHG7\",\"PAX5\",\"IGHV5-78\",\"FCER2\",\"LYZ\",\"AIF1\",\"SERPINA1\",\"IL1B\",\"CPVL\",\"EREG\",\"FCN1\",\"LGALS2\",\"OLR1\",\"FPR3\",\"FPR1\",\"AQP9\",\"CD300E\",\"VMO1\",\"S100A12\",\"CSF3R\",\"CLEC10A\",\"CLEC5A\",\"IL1A\",\"PLA2G7\",\"PTPRT\",\"LRRTM4\",\"NTRK3\",\"FAT3\",\"ENSG00000285822\",\"ENSG00000248973\",\"PRAME\",\"KC6\",\"CHGA\",\"ENSG00000248515\",\"LINC02428\",\"MAGEA4\",\"LINC02167\",\"ENSG00000225087\",\"SORCS3\",\"IRS4\",\"ENSG00000267327\",\"KIF12\",\"FBN3\",\"ENSG00000249413\",\"IGHG4\",\"IGHG1\",\"IGHGP\",\"IGLL5\",\"IGHG3\",\"IGHG2\",\"IGKV4-1\",\"IGLV3-1\",\"IGKV3-20\",\"IGKV1-9\",\"IGLV3-21\",\"IGLC2\",\"CIBAR2\",\"IGLV6-57\",\"IGLC3\",\"IGKV1-16\",\"IGKV1D-13\",\"IGHV3-21\",\"IGHV3-23\",\"IGHV3-11\",\"DSG3\",\"KRT6A\",\"KRT16\",\"LY6D\",\"CLDN4\",\"SLPI\",\"DSG1\",\"HES2\",\"KRTDAP\",\"CLDN7\",\"RHCG\",\"KLK8\",\"SERPINB13\",\"TMPRSS4\",\"ACTL8\",\"MGC32805\",\"PGLYRP3\",\"ADGRF1\",\"A2ML1\",\"S100A7A\",\"COL1A2\",\"COL3A1\",\"COL1A1\",\"PRRX1\",\"COL6A3\",\"DCN\",\"PDGFRB\",\"LUM\",\"SOD3\",\"THBS2\",\"TWIST2\",\"EDNRA\",\"SFRP2\",\"ISLR\",\"CCBE1\",\"PCDH18\",\"EGFL6\",\"RGS5\",\"DPT\",\"TDO2\",\"PCLAF\",\"RRM2\",\"MKI67\",\"UBE2C\",\"CDCA5\",\"BIRC5\",\"CCNA2\",\"GTSE1\",\"PKMYT1\",\"AURKB\",\"NEIL3\",\"HJURP\",\"DLGAP5\",\"SKA1\",\"CDCA3\",\"SPC25\",\"H3C2\",\"KIF18B\",\"SPC24\",\"KIF20A\",\"P2RY6\",\"COL24A1\",\"GLT1D1\",\"SCT\",\"PACSIN1\",\"ENSG00000225885\",\"LILRA4\",\"LINC01374\",\"SMPD3\",\"PTCRA\",\"LAMP5\",\"CLEC4C\",\"SHD\",\"NLRP7\",\"LRRC26\",\"INSYN2A\",\"KCNK10\",\"SMIM5\",\"SCN9A\",\"SLC32A1\",\"ADGRL4\",\"PLVAP\",\"RAMP2\",\"EMCN\",\"VWF\",\"RAMP3\",\"CCL14\",\"DIPK2B\",\"CDH5\",\"MYCT1\",\"CLDN5\",\"KDR\",\"ACKR1\",\"TM4SF18\",\"SELE\",\"CLEC14A\",\"ROBO4\",\"BCL6B\",\"SOX17\",\"ARHGEF15\",\"TPSAB1\",\"TPSB2\",\"CPA3\",\"HDC\",\"HPGDS\",\"HPGD\",\"TPSD1\",\"GATA2\",\"SLC18A2\",\"MS4A2\",\"KIT\",\"PRG2\",\"CTSG\",\"GCSAML\",\"ENSG00000233968\",\"ADCYAP1\",\"MAOB\",\"ENPP3\",\"CLEC4OP\",\"LINC02752\",\"PMEL\",\"TYRP1\",\"MLANA\",\"TYR\",\"TRPM1\",\"SLC24A5\",\"PLP1\",\"LINC00518\",\"SLCO4A1-AS1\",\"DCT\",\"SOX10\",\"S100A1\",\"TRIM63\",\"ALX1\",\"BCAN\",\"BIRC7\",\"ENSG00000225106\",\"LINC02232\",\"GAPDHS\",\"LINC00906\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>p_val<\\/th>\\n      <th>avg_log2FC<\\/th>\\n      <th>pct.1<\\/th>\\n      <th>pct.2<\\/th>\\n      <th>p_val_adj<\\/th>\\n      <th>cluster<\\/th>\\n      <th>gene<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,2,3,4,5]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"p_val\",\"targets\":1},{\"name\":\"avg_log2FC\",\"targets\":2},{\"name\":\"pct.1\",\"targets\":3},{\"name\":\"pct.2\",\"targets\":4},{\"name\":\"p_val_adj\",\"targets\":5},{\"name\":\"cluster\",\"targets\":6},{\"name\":\"gene\",\"targets\":7}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false},\"selection\":{\"mode\":\"multiple\",\"selected\":null,\"target\":\"row\",\"selectable\":null}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n::: {.callout-note collapse=\"false\"}\n-   **Filtragem adicional**: remove genes com pouca relevância ou significância estatística, mantendo apenas aqueles que:\n    -   Têm valor ajustado de p significativo (`p_val_adj <= 0.05`);\n    -   Apresentam diferença de expressão relevante (`avg_log2FC >= 0.25`);\n    -   São detectados em pelo menos 20% das células do cluster (`pct.1 >= 0.20`);\n    -   São mais expressos no cluster alvo do que nos demais (`pct.1 > pct.2`).\n-   **Seleção dos principais marcadores**: para cada cluster, retém apenas os **20 genes com maior log2FC médio**, facilitando a visualização e a escolha de genes para anotação.\n\nEste conjunto de marcadores é particularmente útil para guiar a **anotação manual**, pois foca nos genes mais distintivos de cada população celular.\n:::\n\n### Visualizando marcadores no UMAP\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Plotar expressão de genes marcadores conhecidos para atribuição manual\nFeaturePlot(\n  seurat_object, \n  features = c(\"CD3D\", \"MS4A1\", \"LYZ\", \"PPBP\", \"CD8A\")\n  )\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-feature-1.png){#fig-feature fig-align='center' width=672}\n:::\n:::\n\n\n\n\n### Visualizando atraves do `Bubbleplot`\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Definir genes marcadores para visualização (exemplo)\ngenes_to_inspect <- c(\"CD3D\", \"MS4A1\", \"LYZ\", \"PPBP\", \"CD8A\")\n\n# Gerar o Bubbleplot (DotPlot no Seurat)\nDotPlot(seurat_object, features = genes_to_inspect)\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-bubbleplot-1.png){#fig-bubbleplot fig-align='center' width=672}\n:::\n:::\n\n\n\n\n::: {.callout-note collapse=\"false\"}\nO Bubbleplot (DotPlot) resume a expressão gênica em cada cluster:\n\n-   **Tamanho do ponto** → indica a fração de células do cluster que expressam o gene (quanto maior, mais células expressam).\n-   **Cor do ponto** → representa a expressão média do gene entre as células expressoras (mais escuro = maior expressão).\n\nIsso permite identificar rapidamente quais genes são marcadores de quais clusters e orientar a anotação manual.\n:::\n\n### Avaliação manual dos marcadores\n\n| Cluster | Cell Type | Gene Markers |\n|--------------|-------------------------------|---------------------------|\n| 1 | **CD8+ Cytotoxic T cells** | CD8A, CD8B, GZMK, GZMH, PRF1, IFNG, XCL1, NKG7 |\n| 2 | **CD4+ T cells / TCM-like** | IL7R, TCF7, CAMK4, PDE3B, AOAH |\n| 3 | **Regulatory T cells (Tregs)** | FOXP3, CTLA4, IL2RA, TNFRSF18 (GITR), LAYN |\n| 4 | **B cells** | MS4A1 (CD20), BANK1, CD19, CD22, IGHV5-78 |\n| 5 | **Monocytes (Inflammatory)** | LYZ, FCN1, AIF1, IL1B, S100A12, SERPINA1 |\n| 6 | **Tumor-Associated Cells (Cancer cells, PRAME+)** | PRAME, CHGA, MAGEA4, IRS4, SORCS3 |\n| 7 | **Plasma Cells** | IGHG1, IGHG4, IGHG3, IGLL5, IGKV/IGLV genes |\n| 8 | **Keratinocytes / Tumor-associated Epithelium** | DSG3, KRT6A, KRT16, LY6D, SLPI, CLDN4 |\n| 9 | **Fibroblasts (CAF-like)** | COL1A1, COL3A1, LUM, DCN, PDGFRB, SFRP2 |\n| 10 | **Proliferating Cells (likely cycling tumor cells)** | MKI67, UBE2C, RRM2, CCNA2, BIRC5 |\n| 11 | **Plasmacytoid Dendritic Cells / pDC-like** | CLEC4C, LILRA4, GLT1D1, P2RY6 |\n| 12 | **Endothelial Cells** | CLDN5, ACKR1, PLVAP, RAMP2, EMCN, CDH5 |\n| 13 | **Mast Cells** | TPSAB1, TPSB2, CPA3, HDC, MS4A2 (FCER1) |\n| 14 | **Melanoma Cells (Tumor Melanocytic Cells)** | PMEL, TYRP1, MLANA, TYR, SOX10, TRPM1 |\n\n### Renomeando clusters\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Definir a lista de renomeação\ncluster_annotations <- list(\n  \"1\" = \"CD8+ Cytotoxic T cells\",\n  \"2\" = \"CD4+ T cells / TCM-like\",\n  \"3\" = \"Tregs\",\n  \"4\" = \"B cells\",\n  \"5\" = \"Monocytes\",\n  \"6\" = \"PRAME+ Tumor\",\n  \"7\" = \"Plasma Cells\",\n  \"8\" = \"Keratinocytes/Epithelial\", # Maybe tumor\n  \"9\" = \"Fibroblasts\",\n  \"10\" = \"Proliferating Tumor Cells\",\n  \"11\" = \"Plasmacytoid Dendritic Cells\",\n  \"12\" = \"Endothelial Cells\",\n  \"13\" = \"Mast Cells\",\n  \"14\" = \"Melanoma Cells\"\n)\n\n# Renomear os clusters\ncluster_ids <- as.character(Idents(seurat_object))\n\n# Criando coluna com anotacao manual\nseurat_object$manual_annotation <- as.vector(\n  unlist(cluster_annotations[cluster_ids]))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualizar para conferir\ntable(seurat_object$manual_annotation)\n```\n:::\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Visualizar anotacao\nDimPlot(seurat_object, group.by = \"manual_annotation\", label = FALSE, pt.size = 0.5)\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-manual-annotation-1.png){#fig-manual-annotation fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## Anotação Automática com SingleR\n\nEmbora a anotação manual seja fundamental para garantir a qualidade e o contexto biológico da análise, ela pode ser trabalhosa e depender do conhecimento prévio sobre os tipos celulares presentes. Para facilitar e agilizar esse processo, especialmente em conjuntos de dados grandes ou menos caracterizados, é comum utilizar abordagens automáticas.\n\nO **SingleR** é uma ferramenta projetada para esse fim. Ele anota células individualmente ao comparar seus perfis de expressão com conjuntos de dados de referência já anotados. A atribuição é baseada na similaridade do transcriptoma de cada célula com os perfis médios das populações do banco de referência, o que torna o método eficiente e relativamente robusto para diversas aplicações.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Converter para SingleCellExperiment\nsce <- as.SingleCellExperiment(seurat_object)\n\n# Carregar uma base de referencia\nref <- celldex::HumanPrimaryCellAtlasData()\n\n# Rodar SingleR\npred <- SingleR(\n  test = sce, ref = ref, labels = ref$label.main)\n\n# Adicionar anotação ao objeto Seurat\nseurat_object$SingleR <- pred$labels\n```\n:::\n\n\n\n\n::: {.callout-note collapse=\"false\"}\nEste trecho realiza a **anotação automática das células usando o SingleR** com uma base de referência.\n\n-   `as.SingleCellExperiment(seurat_object)`: converte o objeto Seurat para o formato `SingleCellExperiment`, necessário para rodar o SingleR.\n\n-   `celldex::HumanPrimaryCellAtlasData()`: carrega uma base de referência com perfis de expressão de células humanas bem caracterizadas.\n\n-   `SingleR(test = sce, ref = ref, labels = ref$label.main)`: compara cada célula do dataset com as referências e atribui o tipo celular mais provável.\n\n-   `seurat_object$SingleR <- pred$labels`: adiciona a anotação automática como metadado no objeto Seurat para facilitar a visualização e análise.\n:::\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Visualizar anotacao automatica\nDimPlot(seurat_object, \n        group.by = \"SingleR\", label = FALSE, pt.size = 0.5)\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-automated-annotation-1.png){#fig-automated-annotation fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## Diagnóstico da Anotação com SingleR\n\nEste gráfico mostra os scores de similaridade entre cada célula do conjunto de teste e os tipos celulares da referência. Ele ajuda a identificar células com atribuições ambíguas ou múltiplas similaridades.\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gerar heatmap dos scores de atribuicao\nplotScoreHeatmap(pred)\n```\n:::\n\n\n\n\nOutro diagnóstico é baseado nos \"deltas\" por célula, ou seja, a diferença entre a pontuação do rótulo atribuído e a mediana em todos os rótulos para cada célula. Deltas baixos indicam que a atribuição é incerta, o que é especialmente relevante se o rótulo verdadeiro da célula não existir na referência. Podemos inspecionar esses deltas entre as células para cada rótulo usando a função `plotDeltaDistribution()`.\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Gerar distribuicao dos deltas\nplotDeltaDistribution(pred)\n```\n:::\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\nplotMarkerHeatmap(pred, sce, label = \"NK_cell\")\n```\n:::\n\n\n\n\n\n## Comparando e refinando anotações\n\n### Comparando as anotações com UMAP\n\n\n\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\np1 <- DimPlot(seurat_object, group.by = \"manual_annotation\", label = FALSE) + \n  ggplot2::ggtitle(\"Anotação manual (clusters)\")\n\np2 <- DimPlot(seurat_object, group.by = \"SingleR\", label = FALSE) + \n  ggplot2::ggtitle(\"Anotação automática (SingleR)\")\n\np1\np2\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-umap-annotation-1.png){#fig-umap-annotation-1 fig-align='center' width=672}\n:::\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-umap-annotation-2.png){#fig-umap-annotation-2 fig-align='center' width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Comparar manual vs automática\nconfusion_matrix <- table(\n  Manual = seurat_object$manual_annotation, \n  Automatic = seurat_object$SingleR\n  )\n\n# Normalizar por linha (proporção dentro de cada anotação manual)\nconfusion_prop <- prop.table(confusion_matrix, margin = 1)\n```\n:::\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\" layout-align=\"center\"}\n\n```{.r .cell-code}\n# Visualização da matriz de confusão\npheatmap::pheatmap(\n  confusion_prop,\n  fontsize = 6,\n  display_numbers = TRUE,            # mostra as proporções\n  number_format = \"%.1f\",            # duas casas decimais\n  cluster_rows = FALSE,\n  cluster_cols = FALSE,\n  color = colorRampPalette(c(\"white\", \"steelblue\"))(100)\n)\n```\n\n::: {.cell-output-display}\n![](05_cell_annotation_files/figure-html/fig-confusion-matrix-1.png){#fig-confusion-matrix fig-align='center' width=672}\n:::\n:::\n\n\n\n\n## Salvando o objeto anotado\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(seurat_object, file = \"data/seurat_annotated.RDS\")\n```\n:::\n",
    "supporting": [
      "05_cell_annotation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}